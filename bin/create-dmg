#!/bin/bash
#
# create-dmg packages the aws-okta CLI binary for macOS
# using Apple's signing and notarizing process
#

set -euo pipefail

notarization_status() {
  /Applications/Xcode.app/Contents/Developer/usr/bin/altool --notarization-info "$1" --username "$APPLE_ID_USERNAME" --password "$APPLE_ID_APP_PASSWORD" 2>&1 \
    | awk -F ': ' '/Status:/ { print $2; }'
}

get_apple_id() {
  op read --account petricola.1password.com "op://Parents/Apple/username"
}

get_apple_password() {
  op read --account petricola.1password.com "op://Parents/Apple/Developer/App-specific Password"
}

get_cert_id() {
  op read --account petricola.1password.com "op://Parents/Apple/Developer/Certificate Id"
}

BIN_PATH="$1"
DMG_PATH="$2"
ONE_PASSWORD_ITEM_ID="o4d7yvksmnb4lbhwm5ntmjr4se"
APPLE_ID_USERNAME="${APPLE_ID_USERNAME:-$(get_apple_id)}"
APPLE_ID_APP_PASSWORD="${APPLE_ID_APP_PASSWORD:-$(get_apple_password)}"
CERT_ID="${CERT_ID:-$(get_cert_id)}"
BUNDLE_ID="${BUNDLE_ID:-"com.ensighten.devbox"}"

tmpdir="$(mktemp -d)"
trap "rm -rf $tmpdir" EXIT

cp -a $BIN_PATH $tmpdir/devbox
src_path="$tmpdir/devbox"

echo "Signing binary"
codesign --options runtime --timestamp --sign "$CERT_ID" "$src_path"

echo "Creating dmg"
hdiutil create -quiet -srcfolder "$src_path" "$DMG_PATH"

echo "Signing dmg"
codesign --timestamp --sign "$CERT_ID" "$DMG_PATH"

echo "Submitting notorization request"
request_uuid=$(/Applications/Xcode.app/Contents/Developer/usr/bin/altool --notarize-app --primary-bundle-id "$BUNDLE_ID" --username "$APPLE_ID_USERNAME" --password "$APPLE_ID_APP_PASSWORD" --file $DMG_PATH 2>&1 \
  | awk '/RequestUUID/ { print $NF; }')
echo "Finished submitting, got Request UUID $request_uuid"

echo -n "Waiting for notorization to complete"
while [[ "$(notarization_status "$request_uuid")" == "in progress" ]] ; do
  echo -n .
  sleep 10
done
echo

status="$(notarization_status "$request_uuid")"
if [[ "$status" != "success" ]] ; then
  echo "Notorization status is: $status"
  exit 1
fi

echo "Stapling"
/Applications/Xcode.app/Contents/Developer/usr/bin/stapler staple -q $DMG_PATH
